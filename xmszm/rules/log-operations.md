# 日志操作详细规则

> 本文件在执行日志相关任务时由 LOG-SKILL.md 按需加载

## 📋 目录

- [操作类型判断](#操作类型判断)
- [快速记录操作](#快速记录操作)
- [历史查询操作](#历史查询操作)
- [统计分析操作](#统计分析操作)
- [格式检测与适配](#格式检测与适配)

---

## 操作类型判断

根据用户输入的关键词和上下文，确定具体的日志操作类型。

### 判断矩阵

| 用户输入特征 | 操作类型 | 详细规则章节 |
|------------|---------|------------|
| 包含"记录/log/记一下" | 快速记录 | [快速记录操作](#快速记录操作) |
| 包含"查看/历史/changelog" | 历史查询 | [历史查询操作](#历史查询操作) |
| 包含"统计/分析/报告" | 统计分析 | [统计分析操作](#统计分析操作) |
| 已完成代码修改，需记录 | 快速记录 | [快速记录操作](#快速记录操作) |

### 混合场景处理

**场景**：用户同时提到修改代码和记录日志

**示例**：
- "修改登录页样式并记录"
- "修复bug后写日志"

**处理策略**：
1. 优先执行代码修改（走主workflow）
2. 在主workflow的Step 5自动记录
3. 不需要单独调用日志操作

---

## 快速记录操作

### 触发条件

- 用户明确说"记录"某个已完成的变更
- 有明确的变更描述
- 不涉及代码查看或修改

### 执行流程

#### 1. 项目定位
> 📖 参考 `rules/project-detection.md`

- 检测多项目环境
- 定位 `$PROJECT_ROOT` 和 `$ARCHIVE_PATH`
- 验证归档目录存在

#### 2. 变更信息收集

**自动检测模式**（优先）：
```bash
# 检测未提交的变更
git diff --name-only HEAD

# 如果没有，检测最后一次提交
git diff --name-only HEAD~1..HEAD

# 获取文件的具体行号变更
git diff --stat HEAD
```

**手动模式**（fallback）：
- 用户直接描述了文件路径
- 解析用户输入中的文件信息
- 提示用户补充缺失信息

**信息提取**：
- 变更描述（任务）
- 变更文件列表（带行号）
- 变更类型（新增/修改/修复/优化/重构/删除）

#### 3. 格式检测
> 📖 参考 [格式检测与适配](#格式检测与适配)

检查 `$ARCHIVE_PATH/changelog/` 目录结构：
- 存在 `YYYY-MM/` 目录 → 新格式
- 仅存在 `YYYY-MM.md` 文件 → 旧格式
- 都不存在 → 使用新格式（推荐）

#### 4. 写入日志

**新格式写入**：

1. 确定文件路径：
   ```
   $ARCHIVE_PATH/changelog/YYYY-MM/YYYY-MM-DD.md
   ```

2. 检查文件是否存在：
   - 不存在：创建新文件，使用模板 `templates/changelog-daily.md.template`
   - 已存在：追加到文件末尾

3. 格式化日志条目：
   ```markdown
   ### HH:mm
   - **任务**: [变更描述]
   - **变更文件**:
     - `path/to/file.js:45-60`
     - `path/to/file2.css:12`
   - **类型**: 修改
   - **说明**: [可选补充说明]

   ---
   ```

4. 追加写入文件

5. 更新月份索引：
   - 读取 `changelog/YYYY-MM.md`
   - 更新日期列表和统计信息
   - 如不存在，创建新索引文件

**旧格式写入**：

1. 确定文件路径：
   ```
   $ARCHIVE_PATH/changelog/YYYY-MM.md
   ```

2. 格式化日志条目：
   ```markdown
   ### YYYY-MM-DD HH:mm
   - **任务**: [变更描述]
   - **变更文件**:
     - `path/to/file.js:45-60`
   - **类型**: 修改

   ---
   ```

3. 插入到文件开头（标题之后）：
   - 读取文件前3行（标题部分）
   - 插入新条目
   - 追加原有内容

#### 5. 可选：更新功能归档

如果 `--skip-archive` 未设置：
- 根据变更文件确定归档类型（参考 `rules/task-type-mapping.md`）
- 更新对应的功能归档文件（pages/guides）
- 追加到 `## 最近变更` 章节

#### 6. 多项目环境：更新根索引

如果是多项目环境：
- 更新 `.xmszm/projects.md`
- 修改 `最后变更` 和 `最近任务` 字段

---

## 历史查询操作

### 触发条件

- 用户想查看变更历史
- 包含时间范围或文件名
- 不涉及代码修改

### 查询维度

#### 1. 按日期查询

**关键词**：
- "今天"、"昨天"、"本周"、"本月"
- 具体日期："2026-01-07"
- 日期范围："最近一周"、"1月份"

**实现**：
- 解析日期表达式
- 确定日期范围（起始日期、结束日期）
- 根据格式定位文件：
  - 新格式：列出对应日期的文件 `changelog/YYYY-MM/YYYY-MM-DD.md`
  - 旧格式：读取月份文件，过滤日期范围

#### 2. 按文件查询

**关键词**：
- 文件路径："src/views/Login.vue"
- 文件名："Login.vue"
- 模块名："登录页"、"用户模块"

**实现**：
1. 遍历changelog文件
2. 使用正则匹配文件路径
3. 提取相关记录

#### 3. 按类型查询

**关键词**：
- "修复"、"bug"、"fix"
- "新增"、"添加"、"new"
- "优化"、"重构"、"refactor"

**实现**：
1. 遍历changelog文件
2. 匹配 `**类型**: xxx` 字段
3. 提取符合条件的记录

#### 4. 按关键词查询

**关键词**：
- 任意文本："登录"、"样式"、"API"

**实现**：
1. 遍历changelog文件
2. 在 `**任务**` 和 `**说明**` 字段中搜索
3. 返回匹配的记录

### 输出格式

```markdown
## 查询结果 (共 N 条记录)

### 2026-01-07 14:30
- **任务**: 修复登录页样式问题
- **变更文件**: `src/views/Login.vue:15-30`
- **类型**: 修复
- **说明**: 修复深色模式下按钮不可见的问题

### 2026-01-06 10:20
- **任务**: 优化登录API错误处理
- **变更文件**: `src/api/auth.js:45-60`
- **类型**: 优化

---

**筛选条件**:
- 日期范围: 2026-01-01 ~ 2026-01-07
- 文件: src/views/Login.vue
- 类型: 修复
```

### 性能优化

**策略**：
- 对于日期查询，只读取对应时间范围的文件
- 对于文件查询，可先检查月份索引中的"高频文件"
- 使用流式读取，避免一次性加载大文件
- 限制返回结果数量（默认最近50条）

---

## 统计分析操作

### 触发条件

- 用户需要变更报告
- 包含"统计"、"分析"、"报告"等关键词
- 可能包含时间范围

### 统计指标

#### 1. 变更类型分布

**数据源**：
- 遍历指定时间范围的changelog
- 统计每种类型的出现次数

**输出格式**：
```markdown
## 变更类型分布

| 类型 | 数量 | 占比 |
|-----|------|------|
| 修改 | 45   | 60%  |
| 新增 | 12   | 16%  |
| 修复 | 8    | 11%  |
| 优化 | 5    | 7%   |
| 重构 | 3    | 4%   |
| 删除 | 2    | 3%   |
| **合计** | **75** | **100%** |
```

#### 2. 文件修改热度

**数据源**：
- 提取所有变更文件
- 统计每个文件的修改次数
- 排序取前10或前20

**输出格式**：
```markdown
## 文件修改热度 Top 10

| 排名 | 文件路径 | 修改次数 |
|-----|---------|---------|
| 1   | src/views/Login.vue | 15 |
| 2   | src/api/request.js | 12 |
| 3   | src/styles/common.scss | 8 |
| 4   | src/utils/auth.js | 6 |
| 5   | src/components/Header.vue | 5 |
| ... | ... | ... |
```

#### 3. 每日变更趋势

**数据源**：
- 按日期统计变更次数
- 生成时间序列数据

**输出格式**：
```markdown
## 每日变更趋势

| 日期 | 变更次数 | 趋势 |
|-----|---------|------|
| 2026-01-07 | 8  | ▲ |
| 2026-01-06 | 5  | ▼ |
| 2026-01-05 | 12 | ▲ |
| 2026-01-04 | 7  | ▼ |
| 2026-01-03 | 9  | ▲ |
```

#### 4. 高频变更预警

**规则**：
- 单文件在短时间内（7天）修改次数 > 5次
- 提示可能需要重构

**输出格式**：
```markdown
## ⚠️ 高频变更预警

以下文件在最近7天内频繁修改，建议考虑重构：

- `src/views/Login.vue` - 8次修改
- `src/api/request.js` - 6次修改
```

### 时间范围参数

支持以下格式：
- `today`：今天
- `yesterday`：昨天
- `this-week`：本周
- `this-month`：本月
- `last-month`：上个月
- `YYYY-MM-DD`：具体日期
- `YYYY-MM-DD to YYYY-MM-DD`：日期范围

---

## 格式检测与适配

### 检测算法

```
function detectChangelogFormat(archivePath):
    currentMonth = getCurrentYearMonth()  // 例如: 2026-01

    // 检查是否存在月份目录
    monthDir = archivePath + "/changelog/" + currentMonth
    if exists(monthDir) and isDirectory(monthDir):
        return "new_format"  // 新格式

    // 检查是否存在月度文件
    monthFile = archivePath + "/changelog/" + currentMonth + ".md"
    if exists(monthFile):
        return "old_format"  // 旧格式

    // 都不存在，默认使用新格式
    return "new_format"
```

### 格式适配策略

#### 新格式操作

**写入**：
1. 创建月份目录（如不存在）
2. 写入或追加到日期文件
3. 更新月份索引

**查询**：
1. 根据日期范围列出文件
2. 并行读取多个日期文件
3. 合并结果

**统计**：
1. 遍历月份目录下的所有日期文件
2. 累积统计数据

#### 旧格式操作

**写入**：
1. 读取月度文件
2. 插入到开头（最新在上）
3. 写回文件

**查询**：
1. 读取整个月度文件
2. 逐行解析
3. 过滤日期范围

**统计**：
1. 读取多个月份文件
2. 逐行解析并统计

### 格式迁移

**触发时机**：
- 用户明确要求迁移
- 检测到旧格式且文件过大（>100KB）

**执行**：
- 调用脚本 `scripts/migrate-changelog.sh`
- 备份原文件
- 按日期拆分
- 生成月份索引

---

## 边界情况处理

### 1. Git未安装或非Git项目

**检测**：
```bash
which git || echo "not_found"
git rev-parse --git-dir || echo "not_repo"
```

**处理**：
- 禁用自动检测功能
- 要求用户手动指定变更文件
- 提示：`警告: 自动检测功能不可用，请手动指定变更文件`

### 2. 归档目录不存在

**检测**：
- 检查 `$ARCHIVE_PATH` 是否存在

**处理**：
1. 提示用户：`未找到归档目录，是否初始化？`
2. 用户确认后执行初始化（参考主workflow）
3. 或仅记录到临时文件 `/tmp/xmszm-temp-log.md`

### 3. 文件权限问题

**检测**：
- 写入前检查目录权限

**处理**：
- 显示错误信息
- 提示用户检查权限：`chmod -R u+w $ARCHIVE_PATH`

### 4. 并发写入冲突

**场景**：
- 多人同时记录到同一个日期文件

**处理**：
- 使用文件追加模式（append）而非覆盖
- 建议使用新格式（文件更小，冲突概率低）
- 或使用Git管理changelog，通过merge解决冲突

### 5. 日志文件过大

**检测**：
- 检查单个日志文件大小

**处理**：
- 旧格式：单文件 > 100KB，建议迁移到新格式
- 新格式：单日文件 > 50KB，提示异常（可能记录了过多细节）

### 6. 时区问题

**处理**：
- 统一使用本地时区
- 在日志中不记录时区信息（假设团队在同一时区）
- 如需跨时区，在配置中设置 `timezone` 参数

---

## 配置文件

**位置**：`$ARCHIVE_PATH/.xmszm-config.json`

**格式**：
```json
{
  "changelog": {
    "format": "daily",          // "daily" 新格式 | "monthly" 旧格式
    "autoDetectGit": true,      // 自动检测 git diff
    "updateArchive": true,      // 默认更新功能归档
    "timezone": "Asia/Shanghai" // 时区
  },
  "log": {
    "maxFileSize": "1MB",       // 单个日志文件最大大小
    "retention": "1 year",      // 日志保留时长
    "maxQueryResults": 50       // 查询返回的最大结果数
  }
}
```

**加载逻辑**：
1. 检查配置文件是否存在
2. 不存在则使用默认配置
3. 解析JSON并应用配置
